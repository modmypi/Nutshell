var Designer=function(e,f){function v(a){for(var b=[],j=0;j<a.length;j++)a[j]&&b.push(a[j]);return b}function w(a,b,j){return a.replace(/\{(\w+)\}/gm,function(a,c){var f=b[c];if(j)for(var g=0;g<j.length;g++){var e=j[g](c,f,b);if("string"===typeof e)return e}return f})}function x(a,b){return"string"===typeof b?JSON.stringify(b):null}function K(a,b){return Color.isColor(b)?"ColorHelpers.GetRGB24toRGB565("+b.red+", "+b.green+", "+b.blue+")":null}function L(a,b){return Color.isColor(b)?"{ red: "+b.red+
", green: "+b.green+", blue: "+b.blue+" }":null}function M(a,b){return b.isEnumerationValue?b.value:null}function N(a,b){return b.isEnumerationValue?b.value.charAt(0).toLowerCase()+b.value.substr(1):null}function O(a,b){return Font.isFont(b)?b.name+".ID":null}function P(a,b){return Font.isFont(b)?"Font."+b.name:null}function Q(a,b){return Icon.isIcon(b)?"Icons16."+b.name:b.join?"new ushort[] {"+b.join(",")+"}":null}function R(a,b){return Icon.isIcon(b)?"Icon."+b.name:b.join?"["+b.join(",")+"]":null}
function y(a){a=a.toString();return{name:a.match(/function\s+(\w*)\s*\([^\)]*\)\s*\{/)[1],parameters:a.match(/function\s+\w*\s*\([^\)]*\)\s*\{/)[1],expression:a.match(/\{\s*return\s+([^;]+);\s*\}/)[1]}}function z(a,b){return"function"===typeof b?y(b.toString()).expression:null}function m(a,b){return w(a,b,[x,K,M,O,z,Q])}function p(a,b){return w(a,b,[x,L,N,P,z,R])}function r(a){return JSON.stringify(a,function(b,a){return"editor"===b||"canvas"===b||"parent"===b?void 0:Font.isFont(a)?a.name:Color.isColor(a)?
a.toHex():Icon.isIcon(a)||a.isEnumerationValue?a.name:"function"===typeof a?y(a).expression:a})}function A(a){function b(a){for(var d=0;d<a.length;d++){var c=a[d],h=Primitives[c.command].defaults,g;for(g in c)if(g in h){var e=h[g];"number"===typeof e&&"string"===typeof c[g]?c[g]=new Function("return "+c[g]+";"):Color.isColor(e)?c[g]=new Color(c[g]):Font.isFont(e)?c[g]=Font[c[g]]:Icon.isIcon(e)?c[g]=Icon[c[g]]:e.isEnumerationValue?c[g]=enumeration[e.enumeration][c[g]]:f.isArray(e)&&b(c[g])}}}a=JSON.parse(a);
b(a);return a}function B(a){var b=A(a);Editor.buildEditors(b,k,function(){n(b)});return b}function C(a,b,j){var d=Primitives[a],b=f.extend({paramString:d.paramString},d.defaults,b);a=d.render||a;d=d.paramString;if("loop"===a){for(var a=b.counter,c=p("{from}",b),e=p("{to}",b),g=p("{step}",b),d=Array(j+1).join("    "),a=[d+"for (var "+a+" = "+c+"; "+a+" < "+e+"; "+a+(1==g?"++":" += "+g)+") {"],c=0;c<b.steps.length;c++)e=b.steps[c],e=v(C(e.command,e,j+1).split("\r\n")).join("\r\n    "+d),a.push(d+"    "+
e);a.push("}\r\n");j=a.join("\r\n")}else j="ctx."+(D&&FastDraw[a]?"fast"+a:a)+"("+p(d,b)+");\r\n";return j}function E(a,b,e){var d=Primitives[a],b=f.extend({paramString:d.paramString},d.defaults,b);d=d.paramString;if("loop"===a){for(var d=b.counter,c=m("{from}",b),h=m("{to}",b),g=m("{step}",b),a=Array(e+1).join("    "),d=[a+"for (var "+d+" = "+c+"; "+d+" < "+h+"; "+d+(1==g?"++":" += "+g)+") {"],c=0;c<b.steps.length;c++)h=b.steps[c],h=v(E(h.command,h,e+1).split("\r\n")).join("\r\n    "+a),d.push(a+
"    "+h);d.push("}\r\n");e=d.join("\r\n")}else e="canvas."+a.charAt(0).toUpperCase()+a.substr(1)+"("+m(d,b)+");\r\n";return e}function S(a,b){for(var f=[],d=0;d<a.length;d++){var c=a[d];f.push(C(c.command,c,b||0))}return f.join("")}function T(a,b){for(var f=["var canvas = new VirtualCanvas(null, null);\r\ncanvas.Initialize(GoSockets.Socket5);\r\ncanvas.SetOrientation(Orientation.Landscape);\r\n"],d=0;d<a.length;d++){var c=a[d];f.push(E(c.command,c,b||0))}return f.join("")+"\r\ncanvas.Execute();\r\n"}
function n(a){var b=S(a),f=T(a),d=new Date;s.clearRect(0,0,F,G);eval(b);U.html(new Date-d+"ms");V.val(f);W.val(b);localStorage["Nutshell.__AutoSave"]=r(a)}var q=e.operations||"#operations",k=f(q),X=f(e.toolbar||"#toolbar"),W=f(e.javascript||"#javascript"),V=f(e.csharp||"#csharp"),i=f(e.canvas||"#program-a-paint"),F=e.width||320,G=e.height||240,Y=f(e.zoom||"#zoom-a-paint"),H=f(e.coordinate||"#coordinates"),U=f(e.timeToRender||"#time-to-render"),t=f(e.emulate||"#emulate-hardware"),l=f(e.persistenceToolbar||
"#persistence-toolbar"),u=f(e.loadDialog||"#load-dialog"),D=!t.attr("checked"),s=i[0].getContext("2d"),I=Y[0].getContext("2d"),J=e.rootPath||"/";Draw.initialize(s,i[0]);return function(a){function b(){d=!1;h=a;c=k;f(".handle").hide();k.find(".selected").removeClass("selected").end().find(".property-editor").trigger("operation-deselected")}function e(a){a.addClass("selected").find(".property-editor").trigger("operation-selected");h=c.data("operation");k.animate({scrollTop:k.scrollTop()+a.offset().top-
k.offset().top-100})}a=a||A(localStorage["Nutshell.__AutoSave"]||"[]");k.addClass("operation").data({operation:a,canvas:i});Editor.buildEditors(a,k,function(){n(a)});var d=!1;t.click(function(){D=!t.attr("checked");n(a)});i.mousemove(function(a){var b=i.offset(),f=Math.floor(Math.min(Math.max(0,a.pageX-b.left-(i.outerWidth()-i.innerWidth())/2),i.innerWidth())),c=Math.floor(Math.min(Math.max(0,a.pageY-b.top-(i.outerHeight()-i.innerHeight())/2),i.innerHeight())),a=Math.min(Math.max(0,f-5),F-10),b=Math.min(Math.max(0,
c-5),G-10),a=s.getImageData(a,b,10,10).data,b=I.createImageData(160,160);H.find(".coord-x").text(f);H.find(".coord-y").text(c);for(f=0;10>f;f++)for(c=0;10>c;c++)for(var e=4*(10*c+f),d=64*(160*c+f),g=0;16>g;g++)for(var h=0;16>h;h++){var j=d+4*(160*g+h);b.data[j]=a[e];b.data[j+1]=a[e+1];b.data[j+2]=a[e+2];b.data[j+3]=a[e+3]}I.putImageData(b,0,0)}).on("click",function(){d?b():(b(),d=!0,k.find(".property-editor").trigger("operation-selected"))});f("#frame").on("click",".handle",function(a){b();c=f(a.target).data("operation").editor;
e(c)});var c=k,h=a;f("#operations").on("click",".operation",function(a){b();c=f(f(a.target).parents(".operation")[0]);e(c);return!1});var g=q+","+q+" ol";f(g).sortable({opacity:0.8,connectWith:g,placeholder:"highlight",handle:"h2",cursor:"move",update:function(b,c){var e=c.item.data("operation"),d=c.item[0],g=c.item.parent().data("operation"),h=b.target?f(b.target).data("operation"):g,j=h.indexOf(e),d=f.makeArray(d.parentNode.childNodes).indexOf(d);h.splice(j,1);g.splice(d,0,e);n(a)}});f(q).on("click",
".delete",function(c){var e=f(c.target);if(e.data("disabled")){var d=e.parents(".operation"),g=d.data("operation"),h=f(d[1]).data("operation");h.splice(h.indexOf(g),1);d.first().remove();b();n(a)}else e.html("Confirm").data("disabled",!0).before(f("<a></a>").html("Cancel").attr("href","#").addClass("cancel delete").click(function(a){e.html("Delete").data("disabled",!1);f(a.target).remove();a.stopPropagation();return!1}));c.stopPropagation();return!1});l.find(".save-to-cloud a").click(function(){f("#csharp").val(r(a));
return!1});l.find(".new").click(function(){b();a=B("[]");return!1});l.find(".save").click(function(){var b=l.find("#filename").val(),c=i[0];localStorage["Nutshell.File:"+b]=r(a);localStorage["Nutshell.Date:"+b]=new Date;c&&(localStorage["Nutshell.Screenshot:"+b]=c.toDataURL());return!1});var m=u.dialog({title:u.data("title"),autoOpen:!1,show:{effect:"drop",direction:"up"},hide:{effect:"drop",direction:"up"}});l.find(".load").click(function(){for(var c=[],e=0;e<localStorage.length;e++){var d=localStorage.key(e);
"Nutshell.File:"==d.substr(0,14)&&(d=d.substr(14),c.push({fileName:d,dateModified:new Date(localStorage["Nutshell.Date:"+d])}))}u.find("#local-files ul").empty().append(c.map(function(c){return f("<li></li>").append(f("<a></a>").attr("href","#").click(function(){b();a=B(localStorage["Nutshell.File:"+c.fileName]);l.find("#filename").val(c.fileName);m.dialog("close");return!1}).append(f("<img/>").css({width:80,height:60}).attr({src:localStorage["Nutshell.Screenshot:"+c.fileName],alt:c.fileName})).append(f("<div></div>").text(c.fileName)))[0]}));
m.dialog("open");return!1});ZeroClipboard.setMoviePath(J+"/Scripts/ZeroClipboard.swf");var o=new ZeroClipboard.Client,g=l.find(".copy-csharp");o.setHandCursor(!0);o.addEventListener("onMouseDown",function(){o.setText(f("#csharp").val())});o.glue(g[0]);f("#"+o.movieId).parent().attr("title",g.attr("title"));f.each(Primitives,function(d,g){X.append(f("<li></li>").css("cursor","pointer").append(f("<img/>").attr({src:J+"/Content/"+g.icon,alt:g.name,title:g.name})).click(function(){var i=f.extend(!0,{command:d},
g.defaults),k=h.steps||h.parent||a,m=k.indexOf(h);if("loop"===i.command){i.steps.parent=i;for(var l=h;l&&"loop"!==l.command;)l=l.parent;l&&"loop"===l.command&&(i.counter=String.fromCharCode(l.counter.charCodeAt(0)+1))}-1!==m&&m+1<k.length?(k.splice(m+1,0,i),i=Editor.buildEditor(i,k,k.editor,function(){n(a)},h.editor)):(k.push(i),i=Editor.buildEditor(i,k,k.editor,function(){n(a)}));b();c=i;e(c);n(a)}))});n(a)}};