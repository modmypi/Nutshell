var Editor=function(c){function l(a,b,c,g,e){function d(d){b[c]=g(a.val());if(!d||!d.batch)if("function"===typeof e)e({operation:b,property:c,value:b[c]});else if(e.length)for(d=0;d<e.length;d++)e[d]({operation:b,property:c,value:b[c]})}a.keyup(d).change(d);return d}function m(a,b){return c(b?"<"+b+"></"+b+">":"<span></span>").html(a)}function n(a){var b=parseInt(a,10);try{if(isNaN(b)||b.toString()!==a)return new Function("return "+a+";")}catch(c){}return b}function p(a){return function(b){var c=
n(b);a(b);return c}}function s(a){return function(b){return a[b]}}function t(a){return new Color(a)}function u(a){return Font[a]}function v(a){return Icon[a]}function w(a){return a}function o(a){"function"===typeof a&&(a=a.toString(),a={name:a.match(/function\s+(\w*)\s*\([^\)]*\)\s*\{/)[1],parameters:a.match(/function\s+\w*\s*\([^\)]*\)\s*\{/)[1],expression:a.match(/\{\s*return\s+([^;]+);\s*\}/)[1]}.expression);return a}return{integer:function(a,b,i){var g=b.mapping.integer,e=c.extend({},Primitives[a.command].defaults,
a),e=o(e[g]),d=c("<span></span>"),f=c("<input/>").attr("type","text").val(e),h=c("<div></div>").slider({min:b.min||0,max:b.max||320,value:e,slide:function(a,b){f.val(b.value);j()}}),j=l(f,a,g,n,[i,function(){h.slider("value",f.val())}]);d.append(f,h);return d},coordinates:function(a,b,i){var g=b.mapping.x,b=b.mapping.y,e=c.extend({},Primitives[a.command].defaults,a),d=c("<input/>").attr("type","text").val(o(e[g])),f=c("<input/>").attr("type","text").val(o(e[b])),h=a.canvas.position(),e=function(){var a=
n(d.val()),b=n(f.val());"number"===typeof a&&"number"===typeof b?k.show().css({left:h.left+a-3+"px",top:h.top+b-3+"px"}):k.hide()},j=c("<span></span>").append(m("X: "),d,m("Y: "),f).bind("operation-selected",e).bind("operation-deselected",function(){k.hide()}),k=c("<div></div>").addClass("handle").css({position:"absolute",cursor:"move",width:"5px",height:"5px",border:"solid 1px black",backgroundColor:"white"}).data({operation:a}).hide().draggable({containment:[h.left-3,h.top-3,h.left+a.canvas.width()-
3-1,h.top+a.canvas.height()-3-1],drag:function(a,b){d.val(b.offset.left-h.left+3);f.val(b.offset.top-h.top+3);q({batch:!0});r()}});a.canvas.after(k);var q=l(d,a,g,p(e),i),r=l(f,a,b,p(e),i);return j},range:function(a,b,i){var g=b.mapping.from,e=b.mapping.to,d=c.extend({},Primitives[a.command].defaults,a),f=o(d[g]),h=o(d[e]),d=c("<span></span>"),j=c("<input/>").attr("type","text").val(f),k=c("<input/>").attr("type","text").val(h),q=c("<div></div>").slider({range:!0,min:b.min||0,max:b.max||100,values:[f,
h],slide:function(a,b){b.values[0]!==j.val()&&(j.val(b.values[0]),r());b.values[1]!==k.val()&&(k.val(b.values[1]),p())}}),b=function(){q.slider("values",[j.val(),k.val()])},r=l(j,a,g,n,[i,b]),p=l(k,a,e,n,[i,b]);d.append(m("From: "),j,m("To: "),k,q);return d},string:function(a,b,i){var b=b.mapping.text,g=c.extend({},Primitives[a.command].defaults,a)[b],g=c("<input/>").attr("type","text").val(g);l(g,a,b,w,i);return g},enumeration:function(a,b,i){var g=b.enumeration,b=b.mapping.enumeration,e=c.extend({},
Primitives[a.command].defaults,a)[b],d=c("<select/>"),f;for(f in g)d.append(c("<option/>").html(f));d.val(e.name);l(d,a,b,s(g),i);return d},font:function(a,b,i){var b=b.mapping.font,g=c.extend({},Primitives[a.command].defaults,a)[b],e=c("<select/>"),d;for(d in Font){var f=Font[d];if("object"===typeof f){var h=c("<option/>").html(f.name).val(d);e.append(h);f===g&&h.attr("selected","selected")}}l(e,a,b,u,i);return e},icon:function(a,b,i){var b=b.mapping.icon,g=c.extend({},Primitives[a.command].defaults,
a)[b],e=c("<select/>"),d;for(d in Icon){var f=Icon[d];if(f.isIcon){var h=c("<option/>").html(f.name).val(d);e.append(h);f===g&&h.attr("selected","selected")}}l(e,a,b,v,i);return e},color:function(a,b,i){var b=b.mapping.color,g=c.extend({},Primitives[a.command].defaults,a)[b],e=c("<span></span>"),d=c("<input/>").attr("type","text").val("#"+Color.hex(g)).focus(function(){f.show()}).blur(function(){f.hide()}),f=c("<div></div>").hide().farbtastic(function(a){h||(d.val(a),j())}),h=!1,j=l(d,a,b,t,[i,function(){h=
!0;c.farbtastic(f).setColor((new Color(d.val())).toHtml());h=!1}]);e.append(d,f);return e},program:function(a,b,i){b=b.mapping.program;b=c.extend({},Primitives[a.command].defaults,a)[b];a=c("<ol></ol>").addClass("operation").data({operation:b,canvas:a.canvas});Editor.buildEditors(b,a,i);return a},buildEditor:function(a,b,i,g,e){a.parent=b;a.canvas=i.data("canvas");var b=Primitives[a.command],d=c("<li></li>").append(m(b.name,"h2").css("cursor","move").append(c("<a></a>").html("Delete").attr("href",
"#").addClass("delete"))).addClass("operation").data("operation",a);if(b.editor)for(var f=0;f<b.editor.length;f++){var h=b.editor[f],j=h.type(a,h,g);if(j){var k=c("<div></div>").addClass("edit-area");h.label&&k.append(m(h.label+": "));j.addClass("property-editor");k.append(j);d.append(k)}}0===i.children().length&&d.addClass("first");e?d.insertAfter(e):i.append(d);return a.editor=d},buildEditors:function(a,b,c){b.empty();a.editor=b;b.data("operation",a);for(var g=0;g<a.length;g++)Editor.buildEditor(a[g],
a,b,c);c()}}}(jQuery);